{"version":3,"sources":["browser/tree/tree-selection-impl.ts"],"names":[],"mappings":"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","file":"../../../src/browser/tree/tree-selection-impl.js","sourcesContent":["/********************************************************************************\n * Copyright (C) 2018 TypeFox and others.\n *\n * This program and the accompanying materials are made available under the\n * terms of the Eclipse Public License v. 2.0 which is available at\n * http://www.eclipse.org/legal/epl-2.0.\n *\n * This Source Code may also be made available under the following Secondary\n * Licenses when the conditions for such availability set forth in the Eclipse\n * Public License v. 2.0 are satisfied: GNU General Public License, version 2\n * with the GNU Classpath Exception which is available at\n * https://www.gnu.org/software/classpath/license.html.\n *\n * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0\n ********************************************************************************/\n\nimport {inject, injectable, postConstruct} from 'inversify';\nimport {Tree, TreeNode} from './tree';\nimport {Emitter, Event} from '../../common';\nimport {FocusableTreeSelection, TreeSelectionState} from './tree-selection-state';\nimport {SelectableTreeNode, TreeSelection, TreeSelectionService} from './tree-selection';\n\n@injectable()\nexport class TreeSelectionServiceImpl implements TreeSelectionService {\n\n  @inject(Tree)\n  protected readonly tree: Tree;\n  protected readonly onSelectionChangedEmitter = new Emitter<ReadonlyArray<Readonly<SelectableTreeNode>>>();\n\n  protected state: TreeSelectionState;\n\n  get selectedNodes(): ReadonlyArray<Readonly<SelectableTreeNode>> {\n    return this.state.selection();\n  }\n\n  get onSelectionChanged(): Event<ReadonlyArray<Readonly<SelectableTreeNode>>> {\n    return this.onSelectionChangedEmitter.event;\n  }\n\n  dispose(): void {\n    this.onSelectionChangedEmitter.dispose();\n  }\n\n  addSelection(selectionOrTreeNode: TreeSelection | Readonly<SelectableTreeNode>): void {\n    const selection = ((arg: TreeSelection | Readonly<SelectableTreeNode>): TreeSelection => {\n      const type = TreeSelection.SelectionType.DEFAULT;\n      if (TreeSelection.is(arg)) {\n        return {\n          type,\n          ...arg\n        };\n      }\n      return {\n        type,\n        node: arg\n      };\n    })(selectionOrTreeNode);\n\n    const node = this.validateNode(selection.node);\n    if (node === undefined) {\n      return;\n    }\n    Object.assign(selection, {node});\n\n    const newState = this.state.nextState(selection);\n    this.transiteTo(newState);\n  }\n\n  storeState(): TreeSelectionServiceImpl.State {\n    return {\n      selectionStack: this.state.selectionStack.map(s => ({\n        focus: s.focus && s.focus.id || undefined,\n        node: s.node && s.node.id || undefined,\n        type: s.type\n      }))\n    };\n  }\n\n  restoreState(state: TreeSelectionServiceImpl.State): void {\n    const selectionStack: FocusableTreeSelection[] = [];\n    for (const selection of state.selectionStack) {\n      const node = selection.node && this.tree.getNode(selection.node) || undefined;\n      if (!SelectableTreeNode.is(node)) {\n        break;\n      }\n      const focus = selection.focus && this.tree.getNode(selection.focus) || undefined;\n      selectionStack.push({\n        node,\n        focus: SelectableTreeNode.is(focus) && focus || undefined,\n        type: selection.type\n      });\n    }\n    if (selectionStack.length) {\n      this.transiteTo(new TreeSelectionState(this.tree, selectionStack));\n    }\n  }\n\n  @postConstruct()\n  protected init(): void {\n    this.state = new TreeSelectionState(this.tree);\n  }\n\n  protected fireSelectionChanged(): void {\n    this.onSelectionChangedEmitter.fire(this.state.selection());\n  }\n\n  protected transiteTo(newState: TreeSelectionState): void {\n    const oldNodes = this.state.selection();\n    const newNodes = newState.selection();\n\n    const toUnselect = this.difference(oldNodes, newNodes);\n    const toSelect = this.difference(newNodes, oldNodes);\n\n    this.unselect(toUnselect);\n    this.select(toSelect);\n    this.removeFocus(oldNodes, newNodes);\n    this.addFocus(newState.focus);\n\n    this.state = newState;\n    this.fireSelectionChanged();\n  }\n\n  protected unselect(nodes: ReadonlyArray<SelectableTreeNode>): void {\n    nodes.forEach(node => node.selected = false);\n  }\n\n  protected select(nodes: ReadonlyArray<SelectableTreeNode>): void {\n    nodes.forEach(node => node.selected = true);\n  }\n\n  protected removeFocus(...nodes: ReadonlyArray<SelectableTreeNode>[]): void {\n    nodes.forEach(node => node.forEach(n => n.focus = false));\n  }\n\n  protected addFocus(node: SelectableTreeNode | undefined): void {\n    if (node) {\n      node.focus = true;\n    }\n  }\n\n  /**\n   * Returns an array of the difference of two arrays. The returned array contains all elements that are contained by\n   * `left` and not contained by `right`. `right` may also contain elements not present in `left`: these are simply ignored.\n   */\n  protected difference<T>(left: ReadonlyArray<T>, right: ReadonlyArray<T>): ReadonlyArray<T> {\n    return left.filter(item => right.indexOf(item) === -1);\n  }\n\n  /**\n   * Returns a reference to the argument if the node exists in the tree. Otherwise, `undefined`.\n   */\n  protected validateNode(node: Readonly<TreeNode>): Readonly<TreeNode> | undefined {\n    const result = this.tree.validateNode(node);\n    return SelectableTreeNode.is(result) ? result : undefined;\n  }\n\n}\n\nexport namespace TreeSelectionServiceImpl {\n  export interface State {\n    selectionStack: ReadonlyArray<FocusableTreeSelectionState>\n  }\n\n  export interface FocusableTreeSelectionState {\n    focus?: string\n    node?: string\n    type?: TreeSelection.SelectionType\n  }\n}\n"]}