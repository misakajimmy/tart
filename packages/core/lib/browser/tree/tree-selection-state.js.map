{"version":3,"sources":["browser/tree/tree-selection-state.ts"],"names":[],"mappings":"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","file":"../../../src/browser/tree/tree-selection-state.js","sourcesContent":["/********************************************************************************\n * Copyright (C) 2018 TypeFox and others.\n *\n * This program and the accompanying materials are made available under the\n * terms of the Eclipse Public License v. 2.0 which is available at\n * http://www.eclipse.org/legal/epl-2.0.\n *\n * This Source Code may also be made available under the following Secondary\n * Licenses when the conditions for such availability set forth in the Eclipse\n * Public License v. 2.0 are satisfied: GNU General Public License, version 2\n * with the GNU Classpath Exception which is available at\n * https://www.gnu.org/software/classpath/license.html.\n *\n * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0\n ********************************************************************************/\n\nimport {Tree, TreeNode} from './tree';\nimport {DepthFirstTreeIterator} from './tree-iterator';\nimport {SelectableTreeNode, TreeSelection} from './tree-selection';\n\n/**\n * A tree selection that might contain additional information about the tree node that has the focus.\n */\nexport interface FocusableTreeSelection extends TreeSelection {\n\n  /**\n   * The tree node that has the focus in the tree selection. In case of a range selection,\n   * the `focus` differs from the `node`.\n   */\n  readonly focus?: SelectableTreeNode;\n\n}\n\nexport namespace FocusableTreeSelection {\n\n  /**\n   * `true` if the argument is a focusable tree selection. Otherwise, `false`.\n   */\n  export function is(arg: object | undefined): arg is FocusableTreeSelection {\n    return TreeSelection.is(arg) && 'focus' in arg;\n  }\n\n  /**\n   * Returns with the tree node that has the focus if the argument is a focusable tree selection.\n   * Otherwise, returns `undefined`.\n   */\n  export function focus(arg: TreeSelection | undefined): SelectableTreeNode | undefined {\n    return is(arg) ? arg.focus : undefined;\n  }\n}\n\n/**\n * Class for representing and managing the selection state and the focus of a tree.\n */\nexport class TreeSelectionState {\n\n  constructor(\n      protected readonly tree: Tree,\n      readonly selectionStack: ReadonlyArray<FocusableTreeSelection> = []) {\n  }\n\n  get focus(): SelectableTreeNode | undefined {\n    const copy = this.checkNoDefaultSelection(this.selectionStack);\n    const candidate = copy[copy.length - 1].focus;\n    return this.toSelectableTreeNode(candidate);\n  }\n\n  nextState(selection: FocusableTreeSelection): TreeSelectionState {\n    const {node, type} = {\n      type: TreeSelection.SelectionType.DEFAULT,\n      ...selection\n    };\n    switch (type) {\n      case TreeSelection.SelectionType.DEFAULT:\n        return this.handleDefault(this, node);\n      case TreeSelection.SelectionType.TOGGLE:\n        return this.handleToggle(this, node);\n      case TreeSelection.SelectionType.RANGE:\n        return this.handleRange(this, node);\n      default:\n        throw new Error(`Unexpected tree selection type: ${type}.`);\n    }\n  }\n\n  selection(): ReadonlyArray<SelectableTreeNode> {\n    const copy = this.checkNoDefaultSelection(this.selectionStack);\n    const nodeIds = new Set<string>();\n    for (let i = 0; i < copy.length; i++) {\n      const {node, type} = copy[i];\n      if (TreeSelection.isRange(type)) {\n        const selection = copy[i];\n        for (const id of this.selectionRange(selection).map(n => n.id)) {\n          nodeIds.add(id);\n        }\n      } else if (TreeSelection.isToggle(type)) {\n        if (nodeIds.has(node.id)) {\n          nodeIds.delete(node.id);\n        } else {\n          nodeIds.add(node.id);\n        }\n      }\n    }\n    return Array.from(nodeIds.keys()).map(id => this.tree.getNode(id)).filter(SelectableTreeNode.is).reverse();\n  }\n\n  protected handleDefault(state: TreeSelectionState, node: Readonly<SelectableTreeNode>): TreeSelectionState {\n    const {tree} = state;\n    return new TreeSelectionState(tree, [{\n      node,\n      type: TreeSelection.SelectionType.TOGGLE,\n      focus: node\n    }]);\n  }\n\n  protected handleToggle(state: TreeSelectionState, node: Readonly<SelectableTreeNode>): TreeSelectionState {\n    const {tree, selectionStack} = state;\n    const copy = this.checkNoDefaultSelection(selectionStack).slice();\n    const focus = (() => {\n      const allRanges = copy.filter(selection => TreeSelection.isRange(selection));\n      for (let i = allRanges.length - 1; i >= 0; i--) {\n        const latestRangeIndex = copy.indexOf(allRanges[i]);\n        const latestRangeSelection = copy[latestRangeIndex];\n        const latestRange = latestRangeSelection && latestRangeSelection.focus ? this.selectionRange(latestRangeSelection) : [];\n        if (latestRange.indexOf(node) !== -1) {\n          if (this.focus === latestRangeSelection.focus) {\n            return latestRangeSelection.focus || node;\n          } else {\n            return this.focus;\n          }\n        }\n      }\n      return node;\n    })();\n    return new TreeSelectionState(tree, [...copy, {\n      node,\n      type: TreeSelection.SelectionType.TOGGLE,\n      focus\n    }]);\n  }\n\n  protected handleRange(state: TreeSelectionState, node: Readonly<SelectableTreeNode>): TreeSelectionState {\n    const {tree, selectionStack} = state;\n    const copy = this.checkNoDefaultSelection(selectionStack).slice();\n    let focus = FocusableTreeSelection.focus(copy[copy.length - 1]);\n\n    // Drop the previous range when we are trying to modify that.\n    if (TreeSelection.isRange(copy[copy.length - 1])) {\n      const range = this.selectionRange(copy.pop()!);\n      // And we drop all preceding individual nodes that were contained in the range we are dropping.\n      // That means, anytime we cover individual nodes with a range, they will belong to the range so we need to drop them now.\n      for (let i = copy.length - 1; i >= 0; i--) {\n        if (range.indexOf(copy[i].node) !== -1) {\n          // Make sure to keep a reference to the focus while we are discarding previous elements. Otherwise, we lose this information.\n          focus = copy[i].focus;\n          copy.splice(i, 1);\n        }\n      }\n    }\n    return new TreeSelectionState(tree, [...copy, {\n      node,\n      type: TreeSelection.SelectionType.RANGE,\n      focus\n    }]);\n  }\n\n  /**\n   * Returns with an array of items representing the selection range. The from node is the `focus` the to node\n   * is the selected node itself on the tree selection. Both the `from` node and the `to` node are inclusive.\n   */\n  protected selectionRange(selection: FocusableTreeSelection): Readonly<SelectableTreeNode>[] {\n    const fromNode = selection.focus;\n    const toNode = selection.node;\n    if (fromNode === undefined) {\n      return [];\n    }\n    if (toNode === fromNode) {\n      return [toNode];\n    }\n    const {root} = this.tree;\n    if (root === undefined) {\n      return [];\n    }\n    const to = this.tree.validateNode(toNode);\n    if (to === undefined) {\n      return [];\n    }\n    const from = this.tree.validateNode(fromNode);\n    if (from === undefined) {\n      return [];\n    }\n    let started = false;\n    let finished = false;\n    const range = [];\n    for (const node of new DepthFirstTreeIterator(root, {pruneCollapsed: true})) {\n      if (finished) {\n        break;\n      }\n      // Only collect items which are between (inclusive) the `from` node and the `to` node.\n      if (node === from || node === to) {\n        if (started) {\n          finished = true;\n        } else {\n          started = true;\n        }\n      }\n      if (started) {\n        range.push(node);\n      }\n    }\n\n    // We need to reverse the selection range order.\n    if (range.indexOf(from) > range.indexOf(to)) {\n      range.reverse();\n    }\n    return range.filter(SelectableTreeNode.is);\n  }\n\n  protected toSelectableTreeNode(node: TreeNode | undefined): SelectableTreeNode | undefined {\n    if (!!node) {\n      const candidate = this.tree.getNode(node.id);\n      if (!!candidate) {\n        if (SelectableTreeNode.is(candidate)) {\n          return candidate;\n        } else {\n          console.warn(`Could not map to a selectable tree node. Node with ID: ${node.id} is not a selectable node.`);\n        }\n      } else {\n        console.warn(`Could not map to a selectable tree node. Node does not exist with ID: ${node.id}.`);\n      }\n    }\n    return undefined;\n  }\n\n  /**\n   * Checks whether the argument contains any `DEFAULT` tree selection type. If yes, throws an error, otherwise returns with a reference the argument.\n   */\n  protected checkNoDefaultSelection<T extends TreeSelection>(selections: ReadonlyArray<T>): ReadonlyArray<T> {\n    if (selections.some(selection => selection.type === undefined || selection.type === TreeSelection.SelectionType.DEFAULT)) {\n      throw new Error(`Unexpected DEFAULT selection type. [${selections.map(selection => `ID: ${selection.node.id} | ${selection.type}`).join(', ')}]`);\n    }\n    return selections;\n  }\n\n}\n"]}