{"version":3,"sources":["browser/tree/tree-search.ts"],"names":[],"mappings":"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","file":"../../../src/browser/tree/tree-search.js","sourcesContent":["/********************************************************************************\n * Copyright (C) 2018 TypeFox and others.\n *\n * This program and the accompanying materials are made available under the\n * terms of the Eclipse Public License v. 2.0 which is available at\n * http://www.eclipse.org/legal/epl-2.0.\n *\n * This Source Code may also be made available under the following Secondary\n * Licenses when the conditions for such availability set forth in the Eclipse\n * Public License v. 2.0 are satisfied: GNU General Public License, version 2\n * with the GNU Classpath Exception which is available at\n * https://www.gnu.org/software/classpath/license.html.\n *\n * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0\n ********************************************************************************/\n\nimport {inject, injectable, postConstruct} from 'inversify';\nimport {Disposable, DisposableCollection} from '../../common/disposable';\nimport {Emitter, Event} from '../../common';\nimport {Tree, TreeNode} from './tree';\nimport {TreeDecoration} from './tree-decorator';\nimport {FuzzySearch} from './fuzzy-search';\nimport {TopDownTreeIterator} from './tree-iterator';\nimport {LabelProvider} from '../label-provider';\n\n@injectable()\nexport class TreeSearch implements Disposable {\n\n  @inject(Tree)\n  protected readonly tree: Tree;\n\n  @inject(FuzzySearch)\n  protected readonly fuzzySearch: FuzzySearch;\n\n  @inject(LabelProvider)\n  protected readonly labelProvider: LabelProvider;\n\n  protected readonly disposables = new DisposableCollection();\n  protected readonly filteredNodesEmitter = new Emitter<ReadonlyArray<Readonly<TreeNode>>>();\n\n  protected _filterResult: FuzzySearch.Match<TreeNode>[] = [];\n  protected _filteredNodesAndParents: Set<string> = new Set();\n\n  protected _filteredNodes: ReadonlyArray<Readonly<TreeNode>> = [];\n\n  /**\n   * Returns with the filtered nodes after invoking the `filter` method.\n   */\n  get filteredNodes(): ReadonlyArray<Readonly<TreeNode>> {\n    return this._filteredNodes.slice();\n  }\n\n  /**\n   * Event that is fired when the filtered nodes have been changed.\n   */\n  get onFilteredNodesChanged(): Event<ReadonlyArray<Readonly<TreeNode>>> {\n    return this.filteredNodesEmitter.event;\n  }\n\n  getHighlights(): Map<string, TreeDecoration.CaptionHighlight> {\n    return new Map(this._filterResult.map(m => [m.item.id, this.toCaptionHighlight(m)] as [string, TreeDecoration.CaptionHighlight]));\n  }\n\n  /**\n   * Resolves to all the visible tree nodes that match the search pattern.\n   */\n  async filter(pattern: string | undefined): Promise<ReadonlyArray<Readonly<TreeNode>>> {\n    const {root} = this.tree;\n    this._filteredNodesAndParents = new Set();\n    if (!pattern || !root) {\n      this._filterResult = [];\n      this._filteredNodes = [];\n      this.fireFilteredNodesChanged(this._filteredNodes);\n      return [];\n    }\n    const items = [...new TopDownTreeIterator(root)];\n    const transform = (node: TreeNode) => this.labelProvider.getName(node);\n    this._filterResult = await this.fuzzySearch.filter({\n      items,\n      pattern,\n      transform\n    });\n    this._filteredNodes = this._filterResult.map(({item}) => {\n      this.addAllParentsToFilteredSet(item);\n      return item;\n    });\n    this.fireFilteredNodesChanged(this._filteredNodes);\n    return this._filteredNodes.slice();\n  }\n\n  passesFilters(node: TreeNode): boolean {\n    return this._filteredNodesAndParents.has(node.id);\n  }\n\n  dispose(): void {\n    this.disposables.dispose();\n  }\n\n  @postConstruct()\n  protected init(): void {\n    this.disposables.push(this.filteredNodesEmitter);\n  }\n\n  protected addAllParentsToFilteredSet(node: TreeNode): void {\n    let toAdd: TreeNode | undefined = node;\n    while (toAdd && !this._filteredNodesAndParents.has(toAdd.id)) {\n      this._filteredNodesAndParents.add(toAdd.id);\n      toAdd = toAdd.parent;\n    }\n\n  }\n\n  protected fireFilteredNodesChanged(nodes: ReadonlyArray<Readonly<TreeNode>>): void {\n    this.filteredNodesEmitter.fire(nodes);\n  }\n\n  protected toCaptionHighlight(match: FuzzySearch.Match<TreeNode>): TreeDecoration.CaptionHighlight {\n    return {\n      ranges: match.ranges.map(this.mapRange.bind(this))\n    };\n  }\n\n  protected mapRange(range: FuzzySearch.Range): TreeDecoration.CaptionHighlight.Range {\n    const {offset, length} = range;\n    return {\n      offset,\n      length\n    };\n  }\n}\n"]}