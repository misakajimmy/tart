{"version":3,"sources":["browser/storage-service.ts"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;kFAckF;AAIlF,OAAO,EAAC,cAAc,EAAC,MAAM,2BAA2B,CAAC;AACzD,OAAO,EAAC,aAAa,EAAC,MAAM,yBAAyB,CAAC;AAEtD,eAAO,MAAM,cAAc,eAA4B,CAAC;AAExD;;GAEG;AACH,MAAM,WAAW,cAAc;IAE7B;;OAEG;IACH,OAAO,CAAC,CAAC,EAAE,GAAG,EAAE,MAAM,EAAE,IAAI,EAAE,CAAC,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC;IAEhD;;OAEG;IACH,OAAO,CAAC,CAAC,EAAE,GAAG,EAAE,MAAM,EAAE,YAAY,EAAE,CAAC,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC;IAErD,OAAO,CAAC,CAAC,EAAE,GAAG,EAAE,MAAM,GAAG,OAAO,CAAC,CAAC,GAAG,SAAS,CAAC,CAAC;CACjD;AAOD,qBACa,mBAAoB,YAAW,cAAc;IAEhC,SAAS,CAAC,QAAQ,CAAC,cAAc,EAAE,cAAc,CAAC;IACnD,SAAS,CAAC,QAAQ,CAAC,aAAa,EAAE,aAAa,CAAC;IACvE,OAAO,CAAC,OAAO,CAAe;IAE9B,OAAO,CAAC,CAAC,EAAE,GAAG,EAAE,MAAM,EAAE,IAAI,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC,IAAI,CAAC;IAahD,OAAO,CAAC,CAAC,EAAE,GAAG,EAAE,MAAM,EAAE,YAAY,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC,CAAC,GAAG,SAAS,CAAC;IASjE,SAAS,CAAC,IAAI,IAAI,IAAI;IAUtB,SAAS,CAAC,MAAM,CAAC,GAAG,EAAE,MAAM,GAAG,MAAM;YAKvB,4BAA4B;IAgB1C;;;OAGG;IACH,OAAO,CAAC,gBAAgB;IAWxB,OAAO,CAAC,YAAY;CAIrB","file":"../../src/browser/storage-service.d.ts","sourcesContent":["/********************************************************************************\n * Copyright (C) 2017 TypeFox and others.\n *\n * This program and the accompanying materials are made available under the\n * terms of the Eclipse Public License v. 2.0 which is available at\n * http://www.eclipse.org/legal/epl-2.0.\n *\n * This Source Code may also be made available under the following Secondary\n * Licenses when the conditions for such availability set forth in the Eclipse\n * Public License v. 2.0 are satisfied: GNU General Public License, version 2\n * with the GNU Classpath Exception which is available at\n * https://www.gnu.org/software/classpath/license.html.\n *\n * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0\n ********************************************************************************/\n\nimport {inject, injectable, postConstruct} from 'inversify';\n// import { ILogger } from '../common/logger';\nimport {MessageService} from '../common/message-service';\nimport {WindowService} from './window/window-service';\n\nexport const StorageService = Symbol('IStorageService');\n\n/**\n * The storage service provides an interface to some data storage that allows extensions to keep state among sessions.\n */\nexport interface StorageService {\n\n  /**\n   * Stores the given data under the given key.\n   */\n  setData<T>(key: string, data: T): Promise<void>;\n\n  /**\n   * Returns the data stored for the given key or the provided default value if nothing is stored for the given key.\n   */\n  getData<T>(key: string, defaultValue: T): Promise<T>;\n\n  getData<T>(key: string): Promise<T | undefined>;\n}\n\ninterface LocalStorage {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [key: string]: any;\n}\n\n@injectable()\nexport class LocalStorageService implements StorageService {\n  // @inject(ILogger) protected logger: ILogger;\n  @inject(MessageService) protected readonly messageService: MessageService;\n  @inject(WindowService) protected readonly windowService: WindowService;\n  private storage: LocalStorage;\n\n  setData<T>(key: string, data?: T): Promise<void> {\n    if (data !== undefined) {\n      try {\n        this.storage[this.prefix(key)] = JSON.stringify(data);\n      } catch (e) {\n        this.showDiskQuotaExceededMessage();\n      }\n    } else {\n      delete this.storage[this.prefix(key)];\n    }\n    return Promise.resolve();\n  }\n\n  getData<T>(key: string, defaultValue?: T): Promise<T | undefined> {\n    const result = this.storage[this.prefix(key)];\n    if (result === undefined) {\n      return Promise.resolve(defaultValue);\n    }\n    return Promise.resolve(JSON.parse(result));\n  }\n\n  @postConstruct()\n  protected init(): void {\n    if (typeof window !== 'undefined' && window.localStorage) {\n      this.storage = window.localStorage;\n      this.testLocalStorage();\n    } else {\n      // this.logger.warn(log => log(\"The browser doesn't support localStorage. state will not be persisted across sessions.\"));\n      this.storage = {};\n    }\n  }\n\n  protected prefix(key: string): string {\n    const pathname = typeof window === 'undefined' ? '' : window.location.pathname;\n    return `tart:${pathname}:${key}`;\n  }\n\n  private async showDiskQuotaExceededMessage(): Promise<void> {\n    const READ_INSTRUCTIONS_ACTION = 'Read Instructions';\n    const CLEAR_STORAGE_ACTION = 'Clear Local Storage';\n    const ERROR_MESSAGE = `Your preferred browser's local storage is almost full.\n        To be able to save your current workspace layout or data, you may need to free up some space.\n        You can refer to Tart's documentation page for instructions on how to manually clean\n        your browser's local storage or choose to clear all.`;\n    this.messageService.warn(ERROR_MESSAGE, READ_INSTRUCTIONS_ACTION, CLEAR_STORAGE_ACTION).then(async selected => {\n      if (READ_INSTRUCTIONS_ACTION === selected) {\n        this.windowService.openNewWindow('https://github.com/eclipse-tart/tart/wiki/Cleaning-Local-Storage', {external: true});\n      } else if (CLEAR_STORAGE_ACTION === selected) {\n        this.clearStorage();\n      }\n    });\n  }\n\n  /**\n   * Verify if there is still some spaces left to save another workspace configuration into the local storage of your browser.\n   * If we are close to the limit, use a dialog to notify the user.\n   */\n  private testLocalStorage(): void {\n    const keyTest = this.prefix('Test');\n    try {\n      this.storage[keyTest] = JSON.stringify(new Array(60000));\n    } catch (error) {\n      this.showDiskQuotaExceededMessage();\n    } finally {\n      this.storage.removeItem(keyTest);\n    }\n  }\n\n  private clearStorage(): void {\n    this.storage.clear();\n  }\n\n}\n"]}