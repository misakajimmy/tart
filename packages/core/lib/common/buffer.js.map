{"version":3,"sources":["common/buffer.ts"],"names":[],"mappings":"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","file":"../../src/common/buffer.js","sourcesContent":["/********************************************************************************\n * Copyright (C) 2020 TypeFox and others.\n *\n * This program and the accompanying materials are made available under the\n * terms of the Eclipse Public License v. 2.0 which is available at\n * http://www.eclipse.org/legal/epl-2.0.\n *\n * This Source Code may also be made available under the following Secondary\n * Licenses when the conditions for such availability set forth in the Eclipse\n * Public License v. 2.0 are satisfied: GNU General Public License, version 2\n * with the GNU Classpath Exception which is available at\n * https://www.gnu.org/software/classpath/license.html.\n *\n * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0\n ********************************************************************************/\n/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n// based on https://github.com/microsoft/vscode/blob/04c36be045a94fee58e5f8992d3e3fd980294a84/src/vs/base/common/buffer.ts\n\n/* eslint-disable no-null/no-null */\n\nimport {Buffer as SaferBuffer} from 'safer-buffer';\nimport * as iconv from 'iconv-lite';\nimport * as streams from './stream';\n\nconst hasBuffer = (typeof Buffer !== 'undefined');\nconst hasTextEncoder = (typeof TextEncoder !== 'undefined');\nconst hasTextDecoder = (typeof TextDecoder !== 'undefined');\n\nlet textEncoder: TextEncoder | null;\nlet textDecoder: TextDecoder | null;\n\nexport class BinaryBuffer {\n\n  readonly buffer: Uint8Array;\n  readonly byteLength: number;\n\n  private constructor(buffer: Uint8Array) {\n    this.buffer = buffer;\n    this.byteLength = this.buffer.byteLength;\n  }\n\n  static alloc(byteLength: number): BinaryBuffer {\n    if (hasBuffer) {\n      return new BinaryBuffer(Buffer.allocUnsafe(byteLength));\n    } else {\n      return new BinaryBuffer(new Uint8Array(byteLength));\n    }\n  }\n\n  static wrap(actual: Uint8Array): BinaryBuffer {\n    if (hasBuffer && !(Buffer.isBuffer(actual))) {\n      // https://nodejs.org/dist/latest-v10.x/docs/api/buffer.html#buffer_class_method_buffer_from_arraybuffer_byteoffset_length\n      // Create a zero-copy Buffer wrapper around the ArrayBuffer pointed to by the Uint8Array\n      actual = Buffer.from(actual.buffer, actual.byteOffset, actual.byteLength);\n    }\n    return new BinaryBuffer(actual);\n  }\n\n  static fromString(source: string): BinaryBuffer {\n    if (hasBuffer) {\n      return new BinaryBuffer(Buffer.from(source));\n    } else if (hasTextEncoder) {\n      if (!textEncoder) {\n        textEncoder = new TextEncoder();\n      }\n      return new BinaryBuffer(textEncoder.encode(source));\n    } else {\n      return new BinaryBuffer(iconv.encode(source, 'utf8'));\n    }\n  }\n\n  static concat(buffers: BinaryBuffer[], totalLength?: number): BinaryBuffer {\n    if (typeof totalLength === 'undefined') {\n      totalLength = 0;\n      for (let i = 0, len = buffers.length; i < len; i++) {\n        totalLength += buffers[i].byteLength;\n      }\n    }\n\n    const ret = BinaryBuffer.alloc(totalLength);\n    let offset = 0;\n    for (let i = 0, len = buffers.length; i < len; i++) {\n      const element = buffers[i];\n      ret.set(element, offset);\n      offset += element.byteLength;\n    }\n\n    return ret;\n  }\n\n  toString(): string {\n    if (hasBuffer) {\n      return this.buffer.toString();\n    } else if (hasTextDecoder) {\n      if (!textDecoder) {\n        textDecoder = new TextDecoder();\n      }\n      return textDecoder.decode(this.buffer);\n    } else {\n      return iconv.decode(SaferBuffer.from(this.buffer), 'utf8');\n    }\n  }\n\n  slice(start?: number, end?: number): BinaryBuffer {\n    // IMPORTANT: use subarray instead of slice because TypedArray#slice\n    // creates shallow copy and NodeBuffer#slice doesn't. The use of subarray\n    // ensures the same, performant, behaviour.\n    return new BinaryBuffer(this.buffer.subarray(start, end));\n  }\n\n  set(array: BinaryBuffer, offset?: number): void;\n  set(array: Uint8Array, offset?: number): void;\n  set(array: BinaryBuffer | Uint8Array, offset?: number): void {\n    if (array instanceof BinaryBuffer) {\n      this.buffer.set(array.buffer, offset);\n    } else {\n      this.buffer.set(array, offset);\n    }\n  }\n\n  readUInt32BE(offset: number): number {\n    return (\n        this.buffer[offset] * 2 ** 24\n        + this.buffer[offset + 1] * 2 ** 16\n        + this.buffer[offset + 2] * 2 ** 8\n        + this.buffer[offset + 3]\n    );\n  }\n\n  writeUInt32BE(value: number, offset: number): void {\n    this.buffer[offset + 3] = value;\n    value = value >>> 8;\n    this.buffer[offset + 2] = value;\n    value = value >>> 8;\n    this.buffer[offset + 1] = value;\n    value = value >>> 8;\n    this.buffer[offset] = value;\n  }\n\n  readUInt32LE(offset: number): number {\n    return (\n        ((this.buffer[offset + 0] << 0) >>> 0) |\n        ((this.buffer[offset + 1] << 8) >>> 0) |\n        ((this.buffer[offset + 2] << 16) >>> 0) |\n        ((this.buffer[offset + 3] << 24) >>> 0)\n    );\n  }\n\n  writeUInt32LE(value: number, offset: number): void {\n    this.buffer[offset + 0] = (value & 0b11111111);\n    value = value >>> 8;\n    this.buffer[offset + 1] = (value & 0b11111111);\n    value = value >>> 8;\n    this.buffer[offset + 2] = (value & 0b11111111);\n    value = value >>> 8;\n    this.buffer[offset + 3] = (value & 0b11111111);\n  }\n\n  readUInt8(offset: number): number {\n    return this.buffer[offset];\n  }\n\n  writeUInt8(value: number, offset: number): void {\n    this.buffer[offset] = value;\n  }\n\n}\n\nexport interface BinaryBufferReadable extends streams.Readable<BinaryBuffer> {\n}\n\nexport namespace BinaryBufferReadable {\n  export function toBuffer(readable: BinaryBufferReadable): BinaryBuffer {\n    return streams.consumeReadable<BinaryBuffer>(readable, chunks => BinaryBuffer.concat(chunks));\n  }\n\n  export function fromBuffer(buffer: BinaryBuffer): BinaryBufferReadable {\n    return streams.toReadable<BinaryBuffer>(buffer);\n  }\n\n  export function fromReadable(readable: streams.Readable<string>): BinaryBufferReadable {\n    return {\n      read(): BinaryBuffer | null {\n        const value = readable.read();\n\n        if (typeof value === 'string') {\n          return BinaryBuffer.fromString(value);\n        }\n\n        return null;\n      }\n    };\n  }\n}\n\nexport interface BinaryBufferReadableStream extends streams.ReadableStream<BinaryBuffer> {\n}\n\nexport namespace BinaryBufferReadableStream {\n  export function toBuffer(stream: BinaryBufferReadableStream): Promise<BinaryBuffer> {\n    return streams.consumeStream<BinaryBuffer>(stream, chunks => BinaryBuffer.concat(chunks));\n  }\n\n  export function fromBuffer(buffer: BinaryBuffer): BinaryBufferReadableStream {\n    return streams.toStream<BinaryBuffer>(buffer, chunks => BinaryBuffer.concat(chunks));\n  }\n}\n\nexport interface BinaryBufferReadableBufferedStream extends streams.ReadableBufferedStream<BinaryBuffer> {\n}\n\nexport namespace BinaryBufferReadableBufferedStream {\n  export async function toBuffer(bufferedStream: streams.ReadableBufferedStream<BinaryBuffer>): Promise<BinaryBuffer> {\n    if (bufferedStream.ended) {\n      return BinaryBuffer.concat(bufferedStream.buffer);\n    }\n\n    return BinaryBuffer.concat([\n\n      // Include already read chunks...\n      ...bufferedStream.buffer,\n\n      // ...and all additional chunks\n      await BinaryBufferReadableStream.toBuffer(bufferedStream.stream)\n    ]);\n  }\n}\n\nexport interface BinaryBufferWriteableStream extends streams.WriteableStream<BinaryBuffer> {\n}\n\nexport namespace BinaryBufferWriteableStream {\n  export function create(options?: streams.WriteableStreamOptions): BinaryBufferWriteableStream {\n    return streams.newWriteableStream<BinaryBuffer>(chunks => BinaryBuffer.concat(chunks), options);\n  }\n}\n"]}