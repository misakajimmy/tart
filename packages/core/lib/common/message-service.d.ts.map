{"version":3,"sources":["common/message-service.ts"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;kFAckF;AAGlF,OAAO,EACL,aAAa,EACb,cAAc,EACd,WAAW,EACX,QAAQ,EACR,eAAe,EAEhB,MAAM,4BAA4B,CAAC;AAGpC,eAAO,MAAM,qBAAqB,eAAkC,CAAC;AAErE;;;;;;;;;;;;;;;;;;GAkBG;AACH,qBACa,cAAc;IAME,SAAS,CAAC,QAAQ,CAAC,MAAM,EAAE,aAAa;IAJnE,OAAO,CAAC,gBAAgB,CAA2C;IACnE,OAAO,CAAC,OAAO,CAAK;gBAG0B,MAAM,EAAE,aAAa;IAInE;;;;;;OAMG;IACH,GAAG,CAAC,CAAC,SAAS,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,GAAG,OAAO,EAAE,CAAC,EAAE,GAAG,OAAO,CAAC,CAAC,GAAG,SAAS,CAAC;IAE/E;;;;;;;OAOG;IACH,GAAG,CAAC,CAAC,SAAS,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,OAAO,CAAC,EAAE,cAAc,EAAE,GAAG,OAAO,EAAE,CAAC,EAAE,GAAG,OAAO,CAAC,CAAC,GAAG,SAAS,CAAC;IAOzG;;;;;;OAMG;IACH,IAAI,CAAC,CAAC,SAAS,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,GAAG,OAAO,EAAE,CAAC,EAAE,GAAG,OAAO,CAAC,CAAC,GAAG,SAAS,CAAC;IAEhF;;;;;;;OAOG;IACH,IAAI,CAAC,CAAC,SAAS,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,OAAO,CAAC,EAAE,cAAc,EAAE,GAAG,OAAO,EAAE,CAAC,EAAE,GAAG,OAAO,CAAC,CAAC,GAAG,SAAS,CAAC;IAO1G;;;;;;OAMG;IACH,IAAI,CAAC,CAAC,SAAS,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,GAAG,OAAO,EAAE,CAAC,EAAE,GAAG,OAAO,CAAC,CAAC,GAAG,SAAS,CAAC;IAEhF;;;;;;;OAOG;IACH,IAAI,CAAC,CAAC,SAAS,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,OAAO,CAAC,EAAE,cAAc,EAAE,GAAG,OAAO,EAAE,CAAC,EAAE,GAAG,OAAO,CAAC,CAAC,GAAG,SAAS,CAAC;IAO1G;;;;;;OAMG;IACH,KAAK,CAAC,CAAC,SAAS,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,GAAG,OAAO,EAAE,CAAC,EAAE,GAAG,OAAO,CAAC,CAAC,GAAG,SAAS,CAAC;IAEjF;;;;;;;OAOG;IACH,KAAK,CAAC,CAAC,SAAS,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,OAAO,CAAC,EAAE,cAAc,EAAE,GAAG,OAAO,EAAE,CAAC,EAAE,GAAG,OAAO,CAAC,CAAC,GAAG,SAAS,CAAC;IAO3G;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;OAoCG;IACG,YAAY,CAAC,OAAO,EAAE,eAAe,EAAE,WAAW,CAAC,EAAE,MAAM,IAAI,GAAG,OAAO,CAAC,QAAQ,CAAC;IA6BzF,SAAS,CAAC,cAAc,CAAC,IAAI,EAAE,WAAW,EAAE,IAAI,EAAE,MAAM,EAAE,IAAI,CAAC,EAAE,GAAG,EAAE,GAAG,OAAO,CAAC,MAAM,GAAG,SAAS,CAAC;IAYpG,SAAS,CAAC,aAAa,IAAI,MAAM;CAGlC","file":"../../src/common/message-service.d.ts","sourcesContent":["/********************************************************************************\n * Copyright (C) 2017 TypeFox and others.\n *\n * This program and the accompanying materials are made available under the\n * terms of the Eclipse Public License v. 2.0 which is available at\n * http://www.eclipse.org/legal/epl-2.0.\n *\n * This Source Code may also be made available under the following Secondary\n * Licenses when the conditions for such availability set forth in the Eclipse\n * Public License v. 2.0 are satisfied: GNU General Public License, version 2\n * with the GNU Classpath Exception which is available at\n * https://www.gnu.org/software/classpath/license.html.\n *\n * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0\n ********************************************************************************/\n\nimport {inject, injectable} from 'inversify';\nimport {\n  MessageClient,\n  MessageOptions,\n  MessageType,\n  Progress,\n  ProgressMessage,\n  ProgressUpdate\n} from './message-service-protocol';\nimport {CancellationTokenSource} from './cancellation';\n\nexport const MessageServiceFactory = Symbol('MessageServiceFactory');\n\n/**\n * Service to log and categorize messages, show progress information and offer actions.\n *\n * The messages are processed by this service and forwarded to an injected {@link MessageClient}.\n * For example \"@tart/messages\" provides such a client, rendering messages as notifications\n * in the frontend.\n *\n * ### Example usage\n *\n * ```typescript\n *   @inject(MessageService)\n *   protected readonly messageService: MessageService;\n *\n *   messageService.warn(\"Typings not available\");\n *\n *   messageService.error(\"Could not restore state\", [\"Rollback\", \"Ignore\"])\n *   .then(action => action === \"Rollback\" && rollback());\n * ```\n */\n@injectable()\nexport class MessageService {\n\n  private progressIdPrefix = Math.random().toString(36).substring(5);\n  private counter = 0;\n\n  constructor(\n      @inject(MessageClient) protected readonly client: MessageClient\n  ) {\n  }\n\n  /**\n   * Logs the message and, if given, offers actions to act on it.\n   * @param message the message to log.\n   * @param actions the actions to offer. Can be omitted.\n   *\n   * @returns the selected action if there is any, `undefined` when there was no action or none was selected.\n   */\n  log<T extends string>(message: string, ...actions: T[]): Promise<T | undefined>;\n\n  /**\n   * Logs the message and, if given, offers actions to act on it.\n   * @param message the message to log.\n   * @param options additional options. Can be omitted\n   * @param actions the actions to offer. Can be omitted.\n   *\n   * @returns the selected action if there is any, `undefined` when there was no action or none was selected.\n   */\n  log<T extends string>(message: string, options?: MessageOptions, ...actions: T[]): Promise<T | undefined>;\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  log(message: string, ...args: any[]): Promise<string | undefined> {\n    return this.processMessage(MessageType.Log, message, args);\n  }\n\n  /**\n   * Logs the message as \"info\" and, if given, offers actions to act on it.\n   * @param message the message to log.\n   * @param actions the actions to offer. Can be omitted.\n   *\n   * @returns the selected action if there is any, `undefined` when there was no action or none was selected.\n   */\n  info<T extends string>(message: string, ...actions: T[]): Promise<T | undefined>;\n\n  /**\n   * Logs the message as \"info\" and, if given, offers actions to act on it.\n   * @param message the message to log.\n   * @param options additional options. Can be omitted\n   * @param actions the actions to offer. Can be omitted.\n   *\n   * @returns the selected action if there is any, `undefined` when there was no action or none was selected.\n   */\n  info<T extends string>(message: string, options?: MessageOptions, ...actions: T[]): Promise<T | undefined>;\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  info(message: string, ...args: any[]): Promise<string | undefined> {\n    return this.processMessage(MessageType.Info, message, args);\n  }\n\n  /**\n   * Logs the message as \"warning\" and, if given, offers actions to act on it.\n   * @param message the message to log.\n   * @param actions the actions to offer. Can be omitted.\n   *\n   * @returns the selected action if there is any, `undefined` when there was no action or none was selected.\n   */\n  warn<T extends string>(message: string, ...actions: T[]): Promise<T | undefined>;\n\n  /**\n   * Logs the message as \"warning\" and, if given, offers actions to act on it.\n   * @param message the message to log.\n   * @param options additional options. Can be omitted\n   * @param actions the actions to offer. Can be omitted.\n   *\n   * @returns the selected action if there is any, `undefined` when there was no action or none was selected.\n   */\n  warn<T extends string>(message: string, options?: MessageOptions, ...actions: T[]): Promise<T | undefined>;\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  warn(message: string, ...args: any[]): Promise<string | undefined> {\n    return this.processMessage(MessageType.Warning, message, args);\n  }\n\n  /**\n   * Logs the message as \"error\" and, if given, offers actions to act on it.\n   * @param message the message to log.\n   * @param actions the actions to offer. Can be omitted.\n   *\n   * @returns the selected action if there is any, `undefined` when there was no action or none was selected.\n   */\n  error<T extends string>(message: string, ...actions: T[]): Promise<T | undefined>;\n\n  /**\n   * Logs the message as \"error\" and, if given, offers actions to act on it.\n   * @param message the message to log.\n   * @param options additional options. Can be omitted\n   * @param actions the actions to offer. Can be omitted.\n   *\n   * @returns the selected action if there is any, `undefined` when there was no action or none was selected.\n   */\n  error<T extends string>(message: string, options?: MessageOptions, ...actions: T[]): Promise<T | undefined>;\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  error(message: string, ...args: any[]): Promise<string | undefined> {\n    return this.processMessage(MessageType.Error, message, args);\n  }\n\n  /**\n   * Shows the given message as a progress.\n   *\n   * @param message the message to show for the progress.\n   * @param onDidCancel an optional callback which will be invoked if the progress indicator was canceled.\n   *\n   * @returns a promise resolving to a {@link Progress} object with which the progress can be updated.\n   *\n   * ### Example usage\n   *\n   * ```typescript\n   *   @inject(MessageService)\n   *   protected readonly messageService: MessageService;\n   *\n   *   // this will show \"Progress\" as a cancelable message\n   *   this.messageService.showProgress({text: 'Progress'});\n   *\n   *   // this will show \"Rolling back\" with \"Cancel\" and an additional \"Skip\" action\n   *   this.messageService.showProgress({\n   *     text: `Rolling back`,\n   *     actions: [\"Skip\"],\n   *   },\n   *   () => console.log(\"canceled\"))\n   *   .then((progress) => {\n   *     // register if interested in the result (only necessary for custom actions)\n   *     progress.result.then((result) => {\n   *       // will be 'Cancel', 'Skip' or `undefined`\n   *       console.log(\"result is\", result);\n   *     });\n   *     progress.report({message: \"Cleaning references\", work: {done: 10, total: 100}});\n   *     progress.report({message: \"Restoring previous state\", work: {done: 80, total: 100}});\n   *     progress.report({message: \"Complete\", work: {done: 100, total: 100}});\n   *     // we are done so we can cancel the progress message, note that this will also invoke `onDidCancel`\n   *     progress.cancel();\n   *   });\n   * ```\n   */\n  async showProgress(message: ProgressMessage, onDidCancel?: () => void): Promise<Progress> {\n    const id = this.newProgressId();\n    const cancellationSource = new CancellationTokenSource();\n    const report = (update: ProgressUpdate) => {\n      this.client.reportProgress(id, update, message, cancellationSource.token);\n    };\n    const actions = new Set<string>(message.actions);\n    if (ProgressMessage.isCancelable(message)) {\n      actions.delete(ProgressMessage.Cancel);\n      actions.add(ProgressMessage.Cancel);\n    }\n    const clientMessage = {...message, actions: Array.from(actions)};\n    const result = this.client.showProgress(id, clientMessage, cancellationSource.token);\n    if (ProgressMessage.isCancelable(message) && typeof onDidCancel === 'function') {\n      result.then(value => {\n        if (value === ProgressMessage.Cancel) {\n          onDidCancel();\n        }\n      });\n    }\n    return {\n      id,\n      cancel: () => cancellationSource.cancel(),\n      result,\n      report\n    };\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  protected processMessage(type: MessageType, text: string, args?: any[]): Promise<string | undefined> {\n    if (!!args && args.length > 0) {\n      const first = args[0];\n      const actions = Array.from(new Set<string>(args.filter(a => typeof a === 'string')));\n      const options = (typeof first === 'object' && !Array.isArray(first))\n          ? <MessageOptions>first\n          : undefined;\n      return this.client.showMessage({type, options, text, actions});\n    }\n    return this.client.showMessage({type, text});\n  }\n\n  protected newProgressId(): string {\n    return `${this.progressIdPrefix}-${++this.counter}`;\n  }\n}\n"]}