{"version":3,"sources":["common/reference.ts"],"names":[],"mappings":"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","file":"../../src/common/reference.js","sourcesContent":["/********************************************************************************\n * Copyright (C) 2018 TypeFox and others.\n *\n * This program and the accompanying materials are made available under the\n * terms of the Eclipse Public License v. 2.0 which is available at\n * http://www.eclipse.org/legal/epl-2.0.\n *\n * This Source Code may also be made available under the following Secondary\n * Licenses when the conditions for such availability set forth in the Eclipse\n * Public License v. 2.0 are satisfied: GNU General Public License, version 2\n * with the GNU Classpath Exception which is available at\n * https://www.gnu.org/software/classpath/license.html.\n *\n * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0\n ********************************************************************************/\n\nimport {Disposable, DisposableCollection} from './disposable';\nimport {Event} from './event';\nimport {MaybePromise} from './types';\nimport {Emitter} from './emitter';\n\nexport interface Reference<T> extends Disposable {\n  readonly object: T\n}\n\nexport abstract class AbstractReferenceCollection<K, V extends Disposable> implements Disposable {\n\n  protected readonly _keys = new Map<string, K>();\n  protected readonly _values = new Map<string, V>();\n  protected readonly references = new Map<string, DisposableCollection>();\n\n  protected readonly onDidCreateEmitter = new Emitter<V>();\n  readonly onDidCreate: Event<V> = this.onDidCreateEmitter.event;\n\n  protected readonly onWillDisposeEmitter = new Emitter<V>();\n  readonly onWillDispose: Event<V> = this.onWillDisposeEmitter.event;\n\n  protected readonly toDispose = new DisposableCollection();\n\n  constructor() {\n    this.toDispose.push(this.onDidCreateEmitter);\n    this.toDispose.push(this.onWillDisposeEmitter);\n    this.toDispose.push(Disposable.create(() => this.clear()));\n  }\n\n  dispose(): void {\n    this.toDispose.dispose();\n  }\n\n  clear(): void {\n    for (const value of this._values.values()) {\n      try {\n        value.dispose();\n      } catch (e) {\n        console.error(e);\n      }\n    }\n  }\n\n  has(args: K): boolean {\n    const key = this.toKey(args);\n    return this.references.has(key);\n  }\n\n  keys(): K[] {\n    return [...this._keys.values()];\n  }\n\n  values(): V[] {\n    return [...this._values.values()];\n  }\n\n  get(args: K): V | undefined {\n    const key = this.toKey(args);\n    return this._values.get(key);\n  }\n\n  abstract acquire(args: K): MaybePromise<Reference<V>>;\n\n  protected doAcquire(key: string, object: V): Reference<V> {\n    const references = this.references.get(key) || this.createReferences(key, object);\n    const reference: Reference<V> = {\n      object,\n      dispose: () => {\n      }\n    };\n    references.push(reference);\n    return reference;\n  }\n\n  protected toKey(args: K): string {\n    return JSON.stringify(args);\n  }\n\n  protected createReferences(key: string, value: V): DisposableCollection {\n    const references = new DisposableCollection();\n    references.onDispose(() => value.dispose());\n    const disposeObject = value.dispose.bind(value);\n    value.dispose = () => {\n      this.onWillDisposeEmitter.fire(value);\n      disposeObject();\n      this._values.delete(key);\n      this._keys.delete(key);\n      this.references.delete(key);\n      references!.dispose();\n    };\n    this.references.set(key, references);\n    return references;\n  }\n\n}\n\n\nexport class ReferenceCollection<K, V extends Disposable> extends AbstractReferenceCollection<K, V> {\n\n  protected readonly pendingValues = new Map<string, MaybePromise<V>>();\n\n  constructor(protected readonly factory: (key: K) => MaybePromise<V>) {\n    super();\n  }\n\n  async acquire(args: K): Promise<Reference<V>> {\n    const key = this.toKey(args);\n    const existing = this._values.get(key);\n    if (existing) {\n      return this.doAcquire(key, existing);\n    }\n    const object = await this.getOrCreateValue(key, args);\n    return this.doAcquire(key, object);\n  }\n\n  protected async getOrCreateValue(key: string, args: K): Promise<V> {\n    const existing = this.pendingValues.get(key);\n    if (existing) {\n      return existing;\n    }\n    const pending = this.factory(args);\n    this._keys.set(key, args);\n    this.pendingValues.set(key, pending);\n    try {\n      const value = await pending;\n      this._values.set(key, value);\n      this.onDidCreateEmitter.fire(value);\n      return value;\n    } catch (e) {\n      this._keys.delete(key);\n      throw e;\n    } finally {\n      this.pendingValues.delete(key);\n    }\n  }\n\n}\n\nexport class SyncReferenceCollection<K, V extends Disposable> extends AbstractReferenceCollection<K, V> {\n\n  constructor(protected readonly factory: (key: K) => V) {\n    super();\n  }\n\n  acquire(args: K): Reference<V> {\n    const key = this.toKey(args);\n    const object = this.getOrCreateValue(key, args);\n    return this.doAcquire(key, object);\n  }\n\n  protected getOrCreateValue(key: string, args: K): V {\n    const existing = this._values.get(key);\n    if (existing) {\n      return existing;\n    }\n    const value = this.factory(args);\n    this._keys.set(key, args);\n    this._values.set(key, value);\n    this.onDidCreateEmitter.fire(value);\n    return value;\n  }\n\n}\n"]}